<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <base href="/"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366F1">
    <title>VDFY Recorder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --danger: #ef4444;
            --bg: #F3F4F6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-sec: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--surface);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none; 
            flex-direction: column;
            gap: 16px;
        }

        /* Loading Spinner */
        #pageLoader {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { text-align: center; margin-bottom: 10px; }
        h2 { margin: 0; font-size: 20px; color: var(--text-main); }
        .subtitle { font-size: 14px; color: var(--text-sec); margin-top: 4px; }

        .media-wrapper {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        video { 
            width: 100%; height: 100%; object-fit: cover; display: block; 
            transform: scaleX(1); /* –ù–æ—Ä–º–∞–ª—å–Ω–∏–π –≤–∏–≥–ª—è–¥ (–Ω–µ –¥–∑–µ—Ä–∫–∞–ª–æ) */
        }

        .timer-badge {
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 6px 16px;
            border-radius: 20px; font-size: 16px; font-weight: 600; z-index: 10; pointer-events: none;
        }
        .timer-badge.paused { color: #facc15; }

        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-bottom: 10px; }
        .tab { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 8px; font-weight: 600; color: var(--text-sec); cursor: pointer; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .audio-visual { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #1e1b4b; }
        .mic-circle { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .recording .mic-circle { background: var(--danger); animation: pulse 1.5s infinite; }

        .controls { display: flex; justify-content: center; gap: 20px; align-items: center; margin-top: 10px; }
        
        .btn-rec {
            width: 64px; height: 64px; border-radius: 50%; background: var(--danger);
            border: 4px solid rgba(239, 68, 68, 0.3); cursor: pointer;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); transition: 0.2s;
        }
        .btn-rec:active { transform: scale(0.95); }

        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; background: #f3f4f6; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .btn-primary { width: 100%; padding: 14px; border-radius: 10px; background: var(--primary); color: white; border: none; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { width: 100%; padding: 12px; border-radius: 10px; background: transparent; border: 1px solid #e5e7eb; color: var(--text-main); font-weight: 600; cursor: pointer; margin-top: 5px; }

        .success-card { display: none; text-align: center; padding: 20px; }
        .copy-trigger { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin: 20px 0; }
        .copy-trigger.copied { background: #ecfdf5; border-color: #86efac; }

        /* Error Message Box */
        #error-log { color: #dc2626; font-size: 13px; margin-top: 15px; background: #fee2e2; padding: 12px; border-radius: 8px; display: none; text-align: center; border: 1px solid #fecaca; }

        .hidden { display: none !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

<div id="pageLoader">
    <div class="spinner"></div>
    <p style="color:#6b7280; font-size:14px;">Loading config...</p>
</div>

<div class="container" id="mainContainer">
    <header id="header">
        <h2>üìπ Video Response</h2>
        <div class="subtitle" id="formTitle">Record your answer</div>
    </header>

    <div class="tabs" id="modeSwitch">
        <button class="tab active" onclick="switchMode('video')">Video</button>
        <button class="tab" onclick="switchMode('audio')">Audio Only</button>
    </div>

    <div class="media-wrapper" id="stage">
        <div class="timer-badge" id="timer">00:00</div>
        
        <video id="preview" autoplay muted playsinline></video>
        
        <div id="audioVisualizer" class="audio-visual">
            <div class="mic-circle">üé§</div>
            <div style="color:white; margin-top:10px; font-size:12px;">Microphone Active</div>
        </div>

        <audio id="audioPreview" controls style="display:none; width:90%; position:absolute; bottom:10px; left:5%; z-index:20;"></audio>
    </div>

    <div id="controls-start" class="controls">
        <button class="btn-rec" onclick="startRecording()"></button>
    </div>

    <div id="controls-rec" class="controls hidden">
        <button class="btn-icon" onclick="togglePause()">‚è∏</button>
        <button class="btn-rec" style="background:#374151; border-color:#4b5563; border-radius:12px;" onclick="stopRecording()">‚èπ</button>
    </div>

    <div id="controls-review" class="hidden" style="width:100%;">
        <button id="sendBtn" class="btn-primary" onclick="uploadRecording()">‚úÖ Send Response</button>
        <button id="retakeBtn" class="btn-secondary" onclick="retake()">üîÑ Retake</button>
        <div id="error-log"></div>
    </div>

    <div id="successView" class="success-card">
        <div style="font-size:40px; margin-bottom:10px;">üéâ</div>
        <h3>Uploaded!</h3>
        <p style="color:#6b7280; font-size:14px;">Copy the link and paste it into the form.</p>

        <div class="copy-trigger" onclick="copyLink()">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:20px;">üîó</span>
                <span style="font-weight:600; font-size:14px;">Video Link</span>
            </div>
            <span class="copy-label" style="color:var(--primary); font-weight:700;">COPY</span>
        </div>
        <div id="realLink" style="display:none;"></div>
        <button class="btn-secondary" onclick="window.location.reload()" style="margin-top:20px;">Record Another</button>
    </div>
</div>

<script>
    // --- GLOBAL VARS ---
    let targetEmail = "";
    let formTitleParam = "General";

    // --- 1. INITIALIZATION ---
    async function init() {
        const pathParts = window.location.pathname.split('/');
        const id = pathParts[pathParts.length - 1]; 
        
        // Legacy support (?to=...)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('to')) {
            targetEmail = urlParams.get('to');
            formTitleParam = urlParams.get('form') || "General";
            showApp();
            return;
        }

        if (id && id !== 'recorder.html') {
            try {
                const res = await fetch(`/api/link-info/${id}`);
                if (!res.ok) throw new Error("Link invalid or expired");
                const data = await res.json();
                
                targetEmail = data.email;
                formTitleParam = data.formName || "General";
                
                showApp();
            } catch (e) {
                document.getElementById('pageLoader').innerHTML = 
                    `<p style="color:red; text-align:center">‚ùå Link Expired or Invalid.<br>Please generate a new link.</p>`;
            }
        } else {
            // Direct access (test mode)
            targetEmail = "public_test"; 
            showApp();
        }
    }

    function showApp() {
        document.getElementById('pageLoader').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'flex';
        
        if(formTitleParam && formTitleParam !== "General") {
            document.getElementById('formTitle').innerText = decodeURIComponent(formTitleParam);
        }
        initMedia();
    }

    // --- 2. RECORDING LOGIC ---
    let currentMode = 'video';
    let stream, recorder, chunks = [], seconds = 0, interval, isPaused = false;

    const preview = document.getElementById('preview');
    const audioVisualizer = document.getElementById('audioVisualizer');
    const timerEl = document.getElementById('timer');
    const btnSend = document.getElementById('sendBtn');
    const errorLog = document.getElementById('error-log');
    
    // UI Groups
    const cStart = document.getElementById('controls-start');
    const cRec = document.getElementById('controls-rec');
    const cReview = document.getElementById('controls-review');
    const successView = document.getElementById('successView');
    const modeSwitch = document.getElementById('modeSwitch');

    async function initMedia() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        const constraints = currentMode === 'video' 
            ? { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: true }
            : { video: false, audio: true };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            if (currentMode === 'video') {
                preview.style.display = 'block';
                audioVisualizer.style.display = 'none';
                preview.srcObject = stream;
                preview.muted = true;
                preview.controls = false;
                preview.style.transform = "scaleX(1)"; // No mirror
            } else {
                preview.style.display = 'none';
                audioVisualizer.style.display = 'flex';
            }
            document.getElementById('audioPreview').style.display = 'none';
        } catch (e) { alert("Camera/Mic Access Denied. Please allow permissions."); }
    }

    window.switchMode = (mode) => {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        initMedia();
    };

    function startTimer() {
        clearInterval(interval);
        interval = setInterval(() => {
            if(!isPaused) seconds++;
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            timerEl.innerText = `${mins}:${secs}`;
        }, 1000);
        timerEl.classList.remove('paused');
    }

    window.startRecording = () => {
        chunks = [];
        let options = { mimeType: 'video/webm' };
        // Fallback for Safari/others
        if (!MediaRecorder.isTypeSupported('video/webm')) {
            options = { mimeType: 'video/mp4' };
        }
        
        try { recorder = new MediaRecorder(stream, options); } 
        catch(e) { return alert("Error initializing recorder: " + e.message); }

        recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            if (currentMode === 'video') {
                preview.srcObject = null;
                preview.src = url;
                preview.muted = false;
                preview.controls = true;
                preview.style.transform = "scaleX(1)";
            } else {
                audioVisualizer.style.display = 'none';
                const audioP = document.getElementById('audioPreview');
                audioP.src = url;
                audioP.style.display = 'block';
            }
            cRec.classList.add('hidden');
            cReview.classList.remove('hidden');
            timerEl.style.color = "#10b981";
            if(currentMode === 'audio') document.querySelector('.audio-visual').classList.remove('recording');
        };

        recorder.start();
        cStart.classList.add('hidden');
        cRec.classList.remove('hidden');
        modeSwitch.style.display = 'none';
        if (currentMode === 'video') preview.style.transform = "scaleX(1)";
        if(currentMode === 'audio') document.querySelector('.audio-visual').classList.add('recording');
        
        seconds = 0; timerEl.innerText = "00:00"; isPaused = false;
        startTimer();
    };

    window.togglePause = () => {
        if (isPaused) { recorder.resume(); document.querySelector('.btn-icon').innerText = "‚è∏"; timerEl.classList.remove('paused'); }
        else { recorder.pause(); document.querySelector('.btn-icon').innerText = "‚ñ∂"; timerEl.classList.add('paused'); }
        isPaused = !isPaused;
    };

    window.stopRecording = () => { recorder.stop(); clearInterval(interval); };
    
    // üî• RETAKE RELOADS THE PAGE TO CLEAR BUGS
    window.retake = () => {
        window.location.reload();
    };

    window.uploadRecording = async () => {
        // Fallback email if missing
        const finalEmail = targetEmail || "public_rescue";

        btnSend.innerText = "‚è≥ Uploading...";
        btnSend.disabled = true;
        document.getElementById('retakeBtn').style.display = 'none';
        errorLog.style.display = 'none';

        const blob = new Blob(chunks, { type: 'video/webm' });
        
        // Size check (Cloudflare limit ~100MB)
        if (blob.size > 95 * 1024 * 1024) {
             showError("‚ùå File too large (>100MB). Please record a shorter video.");
             btnSend.disabled = false;
             btnSend.innerText = "‚úÖ Send Response";
             return;
        }

        const formData = new FormData();
        const prefix = currentMode === 'video' ? 'rec_vid_' : 'rec_aud_';
        const formName = formTitleParam || "General";

        formData.append('file', blob, `${prefix}${Date.now()}.webm`);
        formData.append('folder', finalEmail);
        formData.append('subfolder', formName);

        try {
            const res = await fetch('/api/upload-with-ai', { method: 'POST', body: formData });
            
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || "Server Error");
            }
            
            const data = await res.json();
            
            // Show Success UI
            cReview.classList.add('hidden');
            document.getElementById('stage').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            modeSwitch.style.display = 'none';
            successView.style.display = 'block';
            document.getElementById('realLink').innerText = data.publicUrl;

        } catch (e) {
            console.error(e);
            showError("Upload Failed: " + e.message);
            btnSend.innerText = "‚ùå Try Again";
            btnSend.disabled = false;
            document.getElementById('retakeBtn').style.display = 'block';
        }
    };

    function showError(msg) {
        errorLog.innerText = msg;
        errorLog.style.display = 'block';
    }

    window.copyLink = () => {
        const link = document.getElementById('realLink').innerText;
        navigator.clipboard.writeText(link).then(() => {
            const trigger = document.querySelector('.copy-trigger');
            trigger.classList.add('copied');
            trigger.querySelector('.copy-label').innerText = "DONE";
        });
    };

    init();
</script>

</body>
</html>