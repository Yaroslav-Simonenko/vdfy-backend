<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <base href="/"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366F1">
    <title>VDFY Recorder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366F1;
            --danger: #ef4444;
            --bg: #F3F4F6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-sec: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 16px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: var(--surface);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none; /* –°—Ö–æ–≤–∞–Ω–æ –ø–æ–∫–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è –∫–æ–Ω—Ñ—ñ–≥ */
            flex-direction: column;
            gap: 16px;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        #pageLoader {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        header { text-align: center; margin-bottom: 10px; }
        h2 { margin: 0; font-size: 20px; color: var(--text-main); }
        .subtitle { font-size: 14px; color: var(--text-sec); margin-top: 4px; }

        .media-wrapper {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        video { 
            width: 100%; height: 100%; object-fit: cover; display: block; 
            transform: scaleX(-1); /* –î–∑–µ—Ä–∫–∞–ª—å–Ω–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è —Å–µ–ª—Ñ—ñ */
        }

        .timer-badge {
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 6px 16px;
            border-radius: 20px; font-size: 16px; font-weight: 600; z-index: 10; pointer-events: none;
        }
        .timer-badge.paused { color: #facc15; }

        .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-bottom: 10px; }
        .tab { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 8px; font-weight: 600; color: var(--text-sec); cursor: pointer; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .audio-visual { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #1e1b4b; }
        .mic-circle { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .recording .mic-circle { background: var(--danger); animation: pulse 1.5s infinite; }

        .controls { display: flex; justify-content: center; gap: 20px; align-items: center; margin-top: 10px; }
        
        .btn-rec {
            width: 64px; height: 64px; border-radius: 50%; background: var(--danger);
            border: 4px solid rgba(239, 68, 68, 0.3); cursor: pointer;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4); transition: 0.2s;
        }
        .btn-rec:active { transform: scale(0.95); }

        .btn-icon { width: 44px; height: 44px; border-radius: 50%; border: none; background: #f3f4f6; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .btn-primary { width: 100%; padding: 14px; border-radius: 10px; background: var(--primary); color: white; border: none; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .btn-secondary { width: 100%; padding: 12px; border-radius: 10px; background: transparent; border: 1px solid #e5e7eb; color: var(--text-main); font-weight: 600; cursor: pointer; margin-top: 5px; }

        .success-card { display: none; text-align: center; padding: 20px; }
        .copy-trigger { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin: 20px 0; }
        .copy-trigger.copied { background: #ecfdf5; border-color: #86efac; }
        
        .hidden { display: none !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

<div id="pageLoader">
    <div class="spinner"></div>
    <p style="color:#6b7280; font-size:14px;">Loading config...</p>
</div>

<div class="container" id="mainContainer">
    <header id="header">
        <h2>üìπ Video Response</h2>
        <div class="subtitle" id="formTitle">Record your answer</div>
    </header>

    <div class="tabs" id="modeSwitch">
        <button class="tab active" onclick="switchMode('video')">Video</button>
        <button class="tab" onclick="switchMode('audio')">Audio Only</button>
    </div>

    <div class="media-wrapper" id="stage">
        <div class="timer-badge" id="timer">00:00</div>
        
        <video id="preview" autoplay muted playsinline></video>
        
        <div id="audioVisualizer" class="audio-visual">
            <div class="mic-circle">üé§</div>
            <div style="color:white; margin-top:10px; font-size:12px;">Microphone Active</div>
        </div>

        <audio id="audioPreview" controls style="display:none; width:90%; position:absolute; bottom:10px; left:5%; z-index:20;"></audio>
    </div>

    <div id="controls-start" class="controls">
        <button class="btn-rec" onclick="startRecording()"></button>
    </div>

    <div id="controls-rec" class="controls hidden">
        <button class="btn-icon" onclick="togglePause()">‚è∏</button>
        <button class="btn-rec" style="background:#374151; border-color:#4b5563; border-radius:12px;" onclick="stopRecording()">‚èπ</button>
    </div>

    <div id="controls-review" class="hidden" style="width:100%;">
        <button id="sendBtn" class="btn-primary" onclick="uploadRecording()">‚úÖ Send Response</button>
        <button id="retakeBtn" class="btn-secondary" onclick="retake()">üîÑ Retake</button>
    </div>

    <div id="successView" class="success-card">
        <div style="font-size:40px; margin-bottom:10px;">üéâ</div>
        <h3>Uploaded!</h3>
        <p style="color:#6b7280; font-size:14px;">Copy the link and paste it into the form.</p>

        <div class="copy-trigger" onclick="copyLink()">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:20px;">üîó</span>
                <span style="font-weight:600; font-size:14px;">Video Link</span>
            </div>
            <span class="copy-label" style="color:var(--primary); font-weight:700;">COPY</span>
        </div>
        <div id="realLink" style="display:none;"></div>
    </div>
</div>

<script>
    // üî• –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –ö–û–ù–§–Ü–ì–£
    let targetEmail = "";
    let formTitleParam = "General";

    // --- 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø (–ù–æ–≤–∞ –ª–æ–≥—ñ–∫–∞) ---
    async function init() {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ ID —É —à–ª—è—Ö—É /r/XXXXX
        const pathParts = window.location.pathname.split('/');
        const id = pathParts[pathParts.length - 1]; 
        
        // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å—Ç–∞—Ä–∏—Ö –ª—ñ–Ω–∫—ñ–≤ ?to=...
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('to')) {
            targetEmail = urlParams.get('to');
            formTitleParam = urlParams.get('form') || "General";
            showApp();
            return;
        }

        // Fetch config —è–∫—â–æ —î ID
        if (id && id !== 'recorder.html') {
            try {
                const res = await fetch(`/api/link-info/${id}`);
                if (!res.ok) throw new Error("Link invalid");
                const data = await res.json();
                targetEmail = data.email;
                formTitleParam = data.formName || "General";
                showApp();
            } catch (e) {
                document.getElementById('pageLoader').innerHTML = `<p style="color:red">‚ùå Link expired or invalid.</p>`;
            }
        } else {
            document.getElementById('pageLoader').innerHTML = `<p style="color:#6b7280">‚ö†Ô∏è Direct access mode.</p>`;
            showApp();
        }
    }

    function showApp() {
        document.getElementById('pageLoader').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'flex';
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if(formTitleParam && formTitleParam !== "General") {
            document.getElementById('formTitle').innerText = decodeURIComponent(formTitleParam);
        }
        
        initMedia(); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞–º–µ—Ä—É
    }

    // --- 2. –õ–û–ì–Ü–ö–ê –ó–ê–ü–ò–°–£ (–°—Ç–∞—Ä–∞ –¥–æ–±—Ä–∞) ---
    let currentMode = 'video';
    let stream, recorder, chunks = [], seconds = 0, interval, isPaused = false;

    const preview = document.getElementById('preview');
    const audioVisualizer = document.getElementById('audioVisualizer');
    const timerEl = document.getElementById('timer');
    const btnSend = document.getElementById('sendBtn');
    
    const cStart = document.getElementById('controls-start');
    const cRec = document.getElementById('controls-rec');
    const cReview = document.getElementById('controls-review');
    const successView = document.getElementById('successView');
    const modeSwitch = document.getElementById('modeSwitch');
    const header = document.getElementById('header');
    const stage = document.getElementById('stage');

    async function initMedia() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        const constraints = currentMode === 'video' 
            ? { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: true }
            : { video: false, audio: true };

        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            if (currentMode === 'video') {
                preview.style.display = 'block';
                audioVisualizer.style.display = 'none';
                preview.srcObject = stream;
                preview.muted = true;
                preview.controls = false;
            } else {
                preview.style.display = 'none';
                audioVisualizer.style.display = 'flex';
            }
            document.getElementById('audioPreview').style.display = 'none';
        } catch (e) { alert("Camera access denied: " + e.message); }
    }

    window.switchMode = (mode) => {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        initMedia();
    };

    function startTimer() {
        clearInterval(interval);
        interval = setInterval(() => {
            if(!isPaused) seconds++;
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            timerEl.innerText = `${mins}:${secs}`;
        }, 1000);
        timerEl.classList.remove('paused');
    }

    window.startRecording = () => {
        chunks = [];
        let options = { mimeType: 'video/webm;codecs=vp8,opus' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };
        
        try { recorder = new MediaRecorder(stream, options); } catch(e) { return alert("Error init recorder"); }

        recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            if (currentMode === 'video') {
                preview.srcObject = null;
                preview.src = url;
                preview.muted = false;
                preview.controls = true;
                // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –∑–∞–ø–∏—Å—É
                preview.style.transform = "scaleX(1)";
            } else {
                audioVisualizer.style.display = 'none';
                const audioP = document.getElementById('audioPreview');
                audioP.src = url;
                audioP.style.display = 'block';
            }
            cRec.classList.add('hidden');
            cReview.classList.remove('hidden');
            timerEl.style.color = "#10b981";
            if(currentMode === 'audio') document.querySelector('.audio-visual').classList.remove('recording');
        };

        recorder.start();
        cStart.classList.add('hidden');
        cRec.classList.remove('hidden');
        modeSwitch.style.display = 'none';
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è –ø—Ä–µ–≤'—é –∫–∞–º–µ—Ä–∏
        if (currentMode === 'video') preview.style.transform = "scaleX(-1)";
        if(currentMode === 'audio') document.querySelector('.audio-visual').classList.add('recording');
        
        seconds = 0; timerEl.innerText = "00:00"; isPaused = false;
        startTimer();
    };

    window.togglePause = () => {
        if (isPaused) { recorder.resume(); document.querySelector('.btn-icon').innerText = "‚è∏"; timerEl.classList.remove('paused'); }
        else { recorder.pause(); document.querySelector('.btn-icon').innerText = "‚ñ∂"; timerEl.classList.add('paused'); }
        isPaused = !isPaused;
    };

    window.stopRecording = () => { recorder.stop(); clearInterval(interval); };
    
    window.retake = () => {
        if(preview.src) URL.revokeObjectURL(preview.src);
        cReview.classList.add('hidden');
        cStart.classList.remove('hidden');
        modeSwitch.style.display = 'flex';
        timerEl.style.color = "white";
        timerEl.innerText = "00:00";
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ—Å—Ç—å –¥–ª—è —Ä–µ–∂–∏–º—É –∫–∞–º–µ—Ä–∏
        preview.style.transform = "scaleX(-1)";
        initMedia();
    };

    window.uploadRecording = async () => {
        if (!targetEmail) return alert("Error: No recipient config found.");
        btnSend.innerText = "‚è≥ Uploading...";
        btnSend.disabled = true;
        document.getElementById('retakeBtn').style.display = 'none';

        const blob = new Blob(chunks, { type: 'video/webm' });
        const formData = new FormData();
        const prefix = currentMode === 'video' ? 'rec_vid_' : 'rec_aud_';
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ, —è–∫—ñ –º–∏ –¥—ñ—Å—Ç–∞–ª–∏ –≤ init()
        const formName = formTitleParam || "General";

        formData.append('file', blob, `${prefix}${Date.now()}.webm`);
        formData.append('folder', targetEmail);
        formData.append('subfolder', formName);

        try {
            const res = await fetch('/api/upload-with-ai', { method: 'POST', body: formData });
            if (!res.ok) throw new Error("Upload failed");
            const data = await res.json();
            
            cReview.classList.add('hidden');
            stage.style.display = 'none';
            header.style.display = 'none';
            modeSwitch.style.display = 'none';
            successView.style.display = 'block';
            document.getElementById('realLink').innerText = data.publicUrl;
        } catch (e) {
            alert("Error: " + e.message);
            btnSend.innerText = "‚ùå Try Again";
            btnSend.disabled = false;
        }
    };

    window.copyLink = () => {
        navigator.clipboard.writeText(document.getElementById('realLink').innerText);
        const trigger = document.querySelector('.copy-trigger');
        trigger.classList.add('copied');
        trigger.querySelector('.copy-label').innerText = "DONE";
    };

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
    init();
</script>

</body>
</html>